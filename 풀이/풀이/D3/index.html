<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Tic Tac Toe</title>
    <style>
        html, body {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        table {
            border-collapse: collapse;
        }

        td {
            width: 60px;
            height: 60px;
            border: 1px solid rgba(0, 0, 0, 0.3);
            text-align: center;
            font-size: 2rem;
        }
    </style>
</head>
<body>

<div class="container">
    <!--the prompt will be hidden at initial status-->
    <div id="prompt">{{ X || O }} Win!</div>
    <table>
        <tbody>
        <tr>
            <td data-x="0" data-y="0"></td>
            <td data-x="1" data-y="0"></td>
            <td data-x="2" data-y="0"></td>
        </tr>
        <tr>
            <td data-x="0" data-y="1"></td>
            <td data-x="1" data-y="1"></td>
            <td data-x="2" data-y="1"></td>
        </tr>
        <tr>
            <td data-x="0" data-y="2"></td>
            <td data-x="1" data-y="2"></td>
            <td data-x="2" data-y="2"></td>
        </tr>
        </tbody>
    </table>
    <button class="button">Reset</button>
</div>
<script>
    const $td = document.querySelectorAll('td');
    const $reset = document.querySelector('.button');

    let game = [];
    let computerDelay = false;

    const dataLoad = async () => {
        game = await fetch('/backend.php', {
            method: 'get',
            headers: {'Content-Type': 'application/json'}
        })
            .then(res => res.json())
            .then(data => data)
    }

    const gameOverCheck = () => {
        let col = [];
        let row = [];
        let cross = [];

        for (let i = 0; i < game.length; i += 3) {
            col.push(game.slice(i, i + 3))
        }

        for (let i = 0; i < game.length / 3; i++) {
            row.push(game.filter(e => e.x === i));
        }

        let left_cross = [];
        let right_cross = [];
        for (let i = 0; i < game.length; i++) {
            if(i % 4 === 0 || !i) left_cross.push(game[i]);
            if(i === 2 || i === 4 || i === 6) right_cross.push(game[i]);

        }
        cross.push(left_cross,right_cross);

        const check = [...col, ...row, ...cross].map(data => {
            const playerWinChk = data.every(e => {
                const index = game.indexOf(e);
                const gameData = game[index];
                return gameData.player;
            });

            const computerWinChk = data.every(e => {
                const index = game.indexOf(e);
                const gameData = game[index];
                return gameData.computer;
            });
            if(playerWinChk) return 'player';
            if(computerWinChk) return 'computer';
        });

        if(check.some(e => e)) {
            return check.find(e => e);
        } else {
            return false;
        }
    }

    const viewUpdate = async () => {
        const $prompt = document.getElementById('prompt');
        const gameState = gameOverCheck();
        if(gameState && gameState === 'player') {
            $prompt.innerText = 'X win!';
        }
        if(gameState && gameState === 'computer') {
            $prompt.innerText = 'O win!';
        }
        if(!gameState) $prompt.innerText = '';
    }

    const gameUpdateRender = () => {
        $td.forEach(e => {
            const tx = Number(e.dataset.x);
            const ty = Number(e.dataset.y);

            const target = game.find(data => data.x === tx && data.y === ty);
            if (target.check) e.innerText = target.player ? 'X' : 'O';
            else e.innerText = '';
        });
    }

    const init = async () => {
        await dataLoad();
        gameUpdateRender();
        await viewUpdate();
    }

    init();

    $td.forEach(e => {
        e.addEventListener('click', async function () {
            if (computerDelay) return;

            const x = Number(this.dataset.x);
            const y = Number(this.dataset.y);
            await dataLoad();
            const target = game.find(data => data.x === x && data.y === y);
            const checked = target.check;
            if (checked) {
                return alert('이미 선택되었습니다.');
            } else {
                target.check = 1;
                target.player = 1;
                computerDelay = true;
                gameUpdateRender();
                await dataUpdate();
                await viewUpdate();
                if(gameOverCheck()) return;
                setTimeout(() => {
                    const filterComputer = game.filter(data => !data.check && !data.player);
                    const random = Math.floor(Math.random() * filterComputer.length);
                    const randomIndex = game.indexOf(filterComputer[random]);
                    game[randomIndex].check = 1;
                    game[randomIndex].computer = 1;
                    computerDelay = false;
                    gameUpdateRender();
                    dataUpdate();
                    viewUpdate();
                }, 500);
            }
        });
    });

    $reset.addEventListener('click', async function() {
        game.forEach(e => {
            e.computer = 0;
            e.player = 0;
            e.check = 0;
        });
        computerDelay = false;
        await dataUpdate();
        await init();
    })

    const dataUpdate = async () => {
        const formData = new FormData();
        formData.append('data', JSON.stringify(game));
        await fetch('/backend.php', {
            method: 'post',
            body: formData
        })
    }
</script>
</body>
</html>